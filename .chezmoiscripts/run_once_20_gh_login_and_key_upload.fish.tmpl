#!/usr/bin/env fish

if not type -q gh
    echo "â„¹ï¸  GitHub CLI (gh) not installed â€” skipping."
    exit 0
end

# Log in if needed
if not gh auth status >/dev/null 2>&1
    echo "ğŸ” Logging in to GitHub (HTTPS)â€¦"
    gh auth login --hostname github.com --web --git-protocol https
end

# Ensure token has admin:public_key
if not gh auth status -t 2>/dev/null | string match -q "*admin:public_key*"
    echo "ğŸ”§ Adding missing scope admin:public_keyâ€¦"
    gh auth refresh -h github.com -s admin:public_key
end

set -l PUB "$HOME/.ssh/id_ed25519.pub"
set -l TITLE "{{ .chezmoi.hostname }}"

if test -f "$PUB"
    # avoid duplicate upload: compare fingerprint
    set -l fp (ssh-keygen -lf "$PUB" | awk '{print $2}')
    if gh ssh-key list | grep -Fq "$fp"
        echo "âœ… SSH key already uploaded to GitHub."
    else
        echo "â¬†ï¸  Uploading SSH key to GitHubâ€¦"
        if gh ssh-key add "$PUB" -t "$TITLE"
            echo "âœ… Key uploaded."
        else
            echo "âš ï¸  Failed to upload SSH key to GitHub."
        end
    end
else
    echo "âš ï¸  No public key at $PUB â€” skipping upload."
end

# Switch git to SSH
gh config set git_protocol ssh >/dev/null 2>&1; or true
gh auth setup-git        >/dev/null 2>&1; or true
echo "ğŸ” git set to use SSH."
