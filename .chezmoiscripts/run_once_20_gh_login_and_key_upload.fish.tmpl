#!/usr/bin/env sh

# Check if GitHub CLI (gh) is installed
if ! command -v gh >/dev/null 2>&1; then
    echo "GitHub CLI (gh) not installed — skipping."
    exit 0
fi

# Log in if needed
if ! gh auth status >/dev/null 2>&1; then
    echo "Logging in to GitHub (HTTPS)…"
    gh auth login --hostname github.com --web --git-protocol https
fi

# Ensure token has admin:public_key
if ! gh auth status -t 2>/dev/null | grep -q "admin:public_key"; then
    echo "Adding missing scope admin:public_key…"
    gh auth refresh -h github.com -s admin:public_key
fi

PUB="$HOME/.ssh/id_ed25519.pub"
TITLE="{{ .chezmoi.hostname }}"

if [ -f "$PUB" ]; then
    # Avoid duplicate upload: compare fingerprint
    fp=$(ssh-keygen -lf "$PUB" | awk '{print $2}')
    if gh ssh-key list | grep -Fq "$fp"; then
        echo "SSH key already uploaded to GitHub."
    else
        echo "Uploading SSH key to GitHub…"
        if gh ssh-key add "$PUB" -t "$TITLE"; then
            echo "Key uploaded."
        else
            echo "Failed to upload SSH key to GitHub."
        fi
    fi
else
    echo "No public key at $PUB — skipping upload."
fi

# Switch git to SSH
gh config set git_protocol ssh >/dev/null 2>&1 || true
gh auth setup-git >/dev/null 2>&1 || true
echo "git set to use SSH."
