#!/usr/bin/env fish

# ---- Shared ssh-agent for all terminals ----
set -l sock "$XDG_RUNTIME_DIR/ssh-agent.socket"

# If no socket yet, start an agent bound to a fixed path
if not test -S "$sock"
    # Start agent and export env; don't silence this, we need the exports
    eval (ssh-agent -c -a "$sock")
end

# Make every fish session use the same socket (persist + export)
set -Ux SSH_AUTH_SOCK "$sock"
# (Optional but harmless) export the PID too if agent just started
if set -q SSH_AGENT_PID
    set -Ux SSH_AGENT_PID "$SSH_AGENT_PID"
end

# ---- Safe ~/.ssh ----
mkdir -p "$HOME/.ssh"
chmod 700 "$HOME/.ssh"

# Generate per-device key if missing
if not test -f "$HOME/.ssh/id_ed25519"
    echo "üîë Generating per-device SSH key..."
    ssh-keygen -t ed25519 -a 100 -f "$HOME/.ssh/id_ed25519" -C "michal@{{ .chezmoi.hostname }}"
    chmod 600 "$HOME/.ssh/id_ed25519"
    chmod 644 "$HOME/.ssh/id_ed25519.pub"
end

# Add key (now visible from ALL terminals because they share $SSH_AUTH_SOCK)
ssh-add "$HOME/.ssh/id_ed25519"; or true

# ---- GitHub login (HTTPS), upload key, then switch to SSH ----
if type -q gh
    if not gh auth status >/dev/null 2>&1
        echo "üîê Logging in to GitHub (HTTPS)‚Ä¶"
        gh auth login --hostname github.com --web --git-protocol https
    end

    echo "‚¨ÜÔ∏è  Uploading SSH key to GitHub‚Ä¶"
    if gh ssh-key add "$HOME/.ssh/id_ed25519.pub" -t "{{ .chezmoi.hostname }}"
        gh config set git_protocol ssh >/dev/null 2>&1; or true
        gh auth setup-git        >/dev/null 2>&1; or true
        echo "‚úÖ Key uploaded and Git set to use SSH."
    else
        echo "‚ö†Ô∏è  Couldn‚Äôt upload the SSH key. Retry:"
        echo "    gh ssh-key add \"$HOME/.ssh/id_ed25519.pub\" -t \"{{ .chezmoi.hostname }}\""
    end
end
