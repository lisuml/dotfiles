#!/usr/bin/env fish

# Create ~/.ssh with safe perms
mkdir -p "$HOME/.ssh"
chmod 700 "$HOME/.ssh"

# Start ssh-agent (fish uses csh output format)
eval (ssh-agent -c) >/dev/null 2>&1; or true

# Generate per-device key if missing
if not test -f "$HOME/.ssh/id_ed25519"
    echo "üîë Generating per-device SSH key..."
    ssh-keygen -t ed25519 -a 100 -f "$HOME/.ssh/id_ed25519" -C "michal@{{ .chezmoi.hostname }}"
    chmod 600 "$HOME/.ssh/id_ed25519"
    chmod 644 "$HOME/.ssh/id_ed25519.pub"
end

# Add the key to the agent
ssh-add "$HOME/.ssh/id_ed25519" >/dev/null 2>&1; or true

# GitHub: login via HTTPS, ensure scope, upload key, then switch to SSH
if type -q gh
    if not gh auth status -h github.com >/dev/null 2>&1
        echo "üîê Logging in to GitHub (HTTPS first)‚Ä¶"
        gh auth login --hostname github.com --web --git-protocol https
    end

    # Make sure the token has the admin:public_key scope required to add SSH keys
    echo "ü™™ Ensuring token has admin:public_key scope‚Ä¶"
    gh auth refresh -h github.com -s admin:public_key

    echo "‚¨ÜÔ∏è  Uploading SSH key to GitHub‚Ä¶"
    if gh ssh-key add "$HOME/.ssh/id_ed25519.pub" -t "{{ .chezmoi.hostname }}" >/dev/null 2>&1
        gh config set git_protocol ssh >/dev/null 2>&1; or true
        gh auth setup-git >/dev/null 2>&1; or true
        echo "‚úÖ Key uploaded and Git configured to use SSH."
    else
        echo "‚ö†Ô∏è  Couldn‚Äôt upload the SSH key to GitHub."
        echo "   Try manually: gh ssh-key add \"$HOME/.ssh/id_ed25519.pub\" -t \"{{ .chezmoi.hostname }}\""
    end
end
