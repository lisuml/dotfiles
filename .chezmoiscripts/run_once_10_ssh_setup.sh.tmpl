#!/usr/bin/env fish

# ---- Shared ssh-agent for all terminals ----
set -l sock "$XDG_RUNTIME_DIR/ssh-agent.socket"
if not test -S "$sock"
    # Do NOT silence this; we need eval to export agent variables
    eval (ssh-agent -c -a "$sock")
end
# Export universal variables so new terminals use the same socket automatically
set -Ux SSH_AUTH_SOCK "$sock"
if set -q SSH_AGENT_PID
    set -Ux SSH_AGENT_PID "$SSH_AGENT_PID"
end

# ---- Ensure ~/.ssh exists with secure permissions ----
mkdir -p "$HOME/.ssh"
chmod 700 "$HOME/.ssh"

# ---- Generate per-device SSH key if missing ----
if not test -f "$HOME/.ssh/id_ed25519"
    echo "üîë Generating per-device SSH key..."
    ssh-keygen -t ed25519 -a 100 -f "$HOME/.ssh/id_ed25519" -C "michal@{{ .chezmoi.hostname }}"
    chmod 600 "$HOME/.ssh/id_ed25519"
    chmod 644 "$HOME/.ssh/id_ed25519.pub"
end

# ---- Add the key to the running agent ----
ssh-add "$HOME/.ssh/id_ed25519"; or true

# ---- GitHub authentication (HTTPS first), then upload key and switch to SSH ----
if type -q gh
    if not gh auth status >/dev/null 2>&1
        echo "üîê Logging in to GitHub (HTTPS)‚Ä¶"
        gh auth login --hostname github.com --web --git-protocol https
    end

    echo "‚¨ÜÔ∏è  Uploading SSH key to GitHub‚Ä¶"
    if gh ssh-key add "$HOME/.ssh/id_ed25519.pub" -t "{{ .chezmoi.hostname }}"
        # Switch GitHub CLI to SSH once the key is uploaded
        gh config set git_protocol ssh >/dev/null 2>&1; or true
        gh auth setup-git        >/dev/null 2>&1; or true
        echo "‚úÖ Key uploaded and Git set to use SSH."

        # ---- Update dotfiles repo remote URL to SSH (avoid calling chezmoi here) ----
        set repo_dir "{{ .chezmoi.sourceDir }}"
        if test -n "$repo_dir" -a -d "$repo_dir/.git"
            pushd $repo_dir >/dev/null

            # Ensure it's a valid Git repo with a remote named 'origin'
            if git rev-parse --is-inside-work-tree >/dev/null 2>&1
                if git remote | string match -q origin
                    # Prefer push URL if available, fallback to fetch
                    set remote_url (git remote get-url --push origin 2>/dev/null; or git remote get-url origin 2>/dev/null)

                    if test -n "$remote_url"
                        if string match -rq '^https://github\.com/([^/]+)/([^/]+?)(\.git)?$' -- $remote_url
                            set user (string replace -r '^https://github\.com/([^/]+)/.*' '$1' $remote_url)
                            set repo (string replace -r '^https://github\.com/[^/]+/([^/]+?)(\.git)?$' '$1' $remote_url)
                            set ssh_url "git@github.com:$user/$repo.git"
                            echo "üîÑ Updating remote URL to SSH: $ssh_url"
                            git remote set-url origin $ssh_url
                        else if string match -rq '^git@github\.com:.*' -- $remote_url
                            echo "‚ÑπÔ∏è  Remote already uses SSH."
                        else
                            echo "‚ÑπÔ∏è  Remote does not look like a GitHub URL: $remote_url"
                        end
                    else
                        echo "‚ÑπÔ∏è  No remote URL found for 'origin'."
                    end
                else
                    echo "‚ÑπÔ∏è  Repository has no 'origin' remote ‚Äî skipping update."
                end
            else
                echo "‚ÑπÔ∏è  Not a Git working tree ‚Äî skipping update."
            end

            popd >/dev/null
        else
            echo "‚ÑπÔ∏è  Skipping remote update (no repo found at {{ .chezmoi.sourceDir }})."
        end
    else
        echo "‚ö†Ô∏è  Failed to upload SSH key to GitHub. You can retry manually with:"
        echo "    gh ssh-key add \"$HOME/.ssh/id_ed25519.pub\" -t \"{{ .chezmoi.hostname }}\""
    end
end
