#!/usr/bin/env sh

# Update chezmoi source repo remote to SSH (no chezmoi calls to avoid lock)
repo_dir="{{ .chezmoi.sourceDir }}"
if [ -n "$repo_dir" ] && [ -d "$repo_dir/.git" ]; then
    pushd "$repo_dir" >/dev/null
    if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        if git remote | grep -q origin; then
            remote_url=$(git remote get-url --push origin 2>/dev/null || git remote get-url origin 2>/dev/null)
            if [ -n "$remote_url" ]; then
                if echo "$remote_url" | grep -Eq '^https://github\.com/([^/]+)/([^/]+?)(\.git)?$'; then
                    user=$(echo "$remote_url" | sed -E 's|^https://github\.com/([^/]+)/.*|\1|')
                    repo=$(echo "$remote_url" | sed -E 's|^https://github\.com/[^/]+/([^/]+?)(\.git)?$|\1|')
                    ssh_url="git@github.com:$user/$repo"
                    echo "Updating dotfiles remote URL to SSH: $ssh_url"
                    git remote set-url origin "$ssh_url"
                elif echo "$remote_url" | grep -Eq '^git@github\.com:.*'; then
                    echo "Dotfiles remote already uses SSH."
                else
                    echo "Dotfiles remote is not GitHub: $remote_url"
                fi
            else
                echo "No URL for 'origin'."
            fi
        else
            echo "No 'origin' remote — skipping."
        fi
    else
        echo "Not a Git working tree."
    fi
    popd >/dev/null
else
    echo "No repo at $repo_dir — skipping."
fi
